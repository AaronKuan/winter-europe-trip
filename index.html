<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>24å¤©ä¸­æ­å†¬å­£å¤§çœ¾é‹è¼¸ä¹‹æ—…</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* Leaflet Map Height & Transition */
        #map { height: 100%; width: 100%; z-index: 0; background: #e5e7eb; }

        /* Marker Styles */
        .custom-div-icon {
            background: transparent;
            border: none;
        }
        
        .marker-pin {
            width: 30px;
            height: 30px;
            border-radius: 50% 50% 50% 0;
            background: #3b82f6;
            position: absolute;
            transform: rotate(-45deg);
            left: 50%;
            top: 50%;
            margin: -15px 0 0 -15px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 5px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            border: 2px solid white;
        }

        .marker-pin.active {
            transform: rotate(-45deg) scale(1.3);
            border: 3px solid #fcd34d; /* Gold border for active */
            z-index: 1000 !important;
        }

        .marker-pin i {
            transform: rotate(45deg);
            color: white;
            font-size: 14px;
            font-weight: bold;
            font-style: normal;
        }

        /* Marker Colors by Type */
        .type-transport { background: #6b7280; } /* Gray */
        .type-stay { background: #8b5cf6; }      /* Purple */
        .type-visit { background: #ef4444; }     /* Red */
        .type-food { background: #f59e0b; }      /* Amber */

        /* Background Dots (Other days) */
        .bg-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(0,0,0,0.3);
            border: 1px solid white;
        }

        /* Accordion Animation */
        .details-grid {
            display: grid;
            grid-template-rows: 0fr;
            transition: grid-template-rows 0.3s ease-out;
        }
        .details-grid.open {
            grid-template-rows: 1fr;
        }
    </style>
</head>
<body class="bg-gray-50 h-screen w-screen overflow-hidden text-slate-800">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Helper Components ---
        const IconType = ({ type }) => {
            const icons = {
                transport: "fa-train",
                stay: "fa-bed",
                visit: "fa-camera",
                food: "fa-utensils"
            };
            return <i className={`fas ${icons[type] || 'fa-map-marker-alt'} w-5 text-center`}></i>;
        };

        const TypeBadge = ({ type }) => {
            const colors = {
                transport: "bg-gray-100 text-gray-600",
                stay: "bg-purple-100 text-purple-600",
                visit: "bg-red-100 text-red-600",
                food: "bg-amber-100 text-amber-600"
            };
            const labels = {
                transport: "äº¤é€š",
                stay: "ä½å®¿",
                visit: "æ™¯é»",
                food: "é¤é£²"
            };
            return (
                <span className={`text-xs px-2 py-0.5 rounded-full font-medium ${colors[type]}`}>
                    {labels[type]}
                </span>
            );
        };

        // --- Main App Component ---
        const App = () => {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            
            // State
            const [activeDay, setActiveDay] = useState(null); // 'Day 1'
            const [activeSpotId, setActiveSpotId] = useState(null); // Unique ID combination
            const [activeTab, setActiveTab] = useState('itinerary'); // itinerary, search, guide
            const [isMobileListOpen, setIsMobileListOpen] = useState(true); // For mobile toggle

            // Map Ref
            const mapInstance = useRef(null);
            const markersRef = useRef([]);
            const polylineRef = useRef(null);

            // 1. Fetch Data
            useEffect(() => {
                fetch('./itinerary.json')
                    .then(res => {
                        if (!res.ok) throw new Error("ç„¡æ³•è®€å– itinerary.json");
                        return res.json();
                    })
                    .then(json => {
                        setData(json);
                        setLoading(false);
                    })
                    .catch(err => {
                        console.error(err);
                        setError(err.message);
                        setLoading(false);
                    });
            }, []);

            // 2. Initialize Map
            useEffect(() => {
                if (!document.getElementById('map') || mapInstance.current) return;

                const map = L.map('map', {
                    zoomControl: false,
                    attributionControl: false
                }).setView([48.1351, 11.5820], 5); // Default center (Munich)

                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; OpenStreetMap &copy; CARTO',
                    maxZoom: 19
                }).addTo(map);

                L.control.zoom({ position: 'topright' }).addTo(map);
                mapInstance.current = map;

                return () => {
                    if (mapInstance.current) {
                        mapInstance.current.remove();
                        mapInstance.current = null;
                    }
                };
            }, [loading]); // Wait until loading finishes to ensure div exists

            // 3. Update Map Markers & View (The Core Logic)
            useEffect(() => {
                if (!mapInstance.current || data.length === 0) return;
                const map = mapInstance.current;

                // Clear existing layers
                markersRef.current.forEach(m => map.removeLayer(m));
                markersRef.current = [];
                if (polylineRef.current) map.removeLayer(polylineRef.current);

                const allSpots = [];
                const daySpots = [];
                const activeSpotData = [];

                // Flatten data for easier processing
                data.forEach(day => {
                    day.spots.forEach((spot, idx) => {
                        const spotId = `${day.day}-${idx}`;
                        const isDayActive = activeDay === day.day;
                        const isSpotActive = activeSpotId === spotId;

                        const spotData = { ...spot, day: day.day, id: spotId, idx: idx, isDayActive, isSpotActive };
                        allSpots.push(spotData);
                        
                        if (isDayActive) daySpots.push(spotData);
                        if (isSpotActive) activeSpotData.push(spotData);
                    });
                });

                // --- Draw Polyline (Level 1 Context) ---
                if (!activeDay) {
                    const latlngs = allSpots.map(s => [s.lat, s.lng]);
                    polylineRef.current = L.polyline(latlngs, {
                        color: '#3b82f6',
                        weight: 3,
                        opacity: 0.6,
                        dashArray: '5, 10'
                    }).addTo(map);
                }

                // --- Draw Markers ---
                allSpots.forEach(spot => {
                    // Decide visibility based on levels
                    // Level 1: Show Cities (Simulated by showing 1st spot of each day as dot)
                    // Level 2: Show Current Day (Pins) + Background (Dots)
                    
                    let iconHtml = '';
                    let className = '';
                    let zIndex = 0;

                    if (activeDay) {
                        if (spot.isDayActive) {
                            // Main Actor
                            className = `marker-pin type-${spot.type} ${spot.isSpotActive ? 'active' : ''}`;
                            iconHtml = `<div class="${className}"><i>${spot.idx + 1}</i></div>`;
                            zIndex = 1000;
                        } else {
                            // Background Actor
                            // Cycle 5 colors for background dots based on day index
                            const dayNum = parseInt(spot.day.replace('Day ', ''));
                            const colors = ['bg-red-300', 'bg-blue-300', 'bg-green-300', 'bg-yellow-300', 'bg-purple-300'];
                            const bgClass = colors[dayNum % 5];
                            className = `bg-dot ${bgClass}`;
                            iconHtml = `<div class="${className}"></div>`;
                            zIndex = 100;
                        }
                    } else {
                        // Level 1: Overview - Simple dots
                         if (spot.idx === 0) { // Only show major nodes
                            className = `bg-dot bg-blue-500 w-3 h-3 border-2 border-white`;
                            iconHtml = `<div class="${className}"></div>`;
                        } else {
                            return; // Skip minor spots in overview
                        }
                    }

                    const icon = L.divIcon({
                        className: 'custom-div-icon',
                        html: iconHtml,
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    });

                    const marker = L.marker([spot.lat, spot.lng], { icon, zIndexOffset: zIndex })
                        .addTo(map)
                        .on('click', () => {
                            if (spot.day !== activeDay) {
                                setActiveDay(spot.day);
                                setActiveSpotId(null);
                            } else {
                                handleSpotClick(spot.day, spot.idx, spot);
                            }
                        });
                    
                    markersRef.current.push(marker);
                });

                // --- Camera Movement (Cinematic) ---
                const moveOpts = { animate: true, duration: 1.5, easeLinearity: 0.25 };

                if (activeSpotId && activeSpotData.length > 0) {
                    // Level 3: Focus
                    const s = activeSpotData[0];
                    map.flyTo([s.lat, s.lng], 16, moveOpts);
                } else if (activeDay && daySpots.length > 0) {
                    // Level 2: Day View
                    const group = L.featureGroup(daySpots.map(s => L.marker([s.lat, s.lng])));
                    map.fitBounds(group.getBounds().pad(0.2), moveOpts);
                } else {
                    // Level 1: Overview
                    if (allSpots.length > 0) {
                         const group = L.featureGroup(allSpots.map(s => L.marker([s.lat, s.lng])));
                         map.fitBounds(group.getBounds().pad(0.1), moveOpts);
                    }
                }

            }, [activeDay, activeSpotId, data]);


            // Actions
            const toggleDay = (day) => {
                if (activeDay === day) {
                    setActiveDay(null); // Collapse to Level 1
                    setActiveSpotId(null);
                } else {
                    setActiveDay(day);
                    setActiveSpotId(null); // Reset focus
                }
            };

            const handleSpotClick = (dayId, idx, spot) => {
                const uniqueId = `${dayId}-${idx}`;
                if (activeSpotId === uniqueId) {
                    setActiveSpotId(null); // Toggle off (Back to Level 2)
                } else {
                    setActiveDay(dayId); // Ensure day is open
                    setActiveSpotId(uniqueId); // Go to Level 3
                }
            };

            const openGoogleMaps = (e, name, city) => {
                e.stopPropagation();
                const query = encodeURIComponent(`${name} ${city}`);
                window.open(`https://www.google.com/maps/search/?api=1&query=${query}`, '_blank');
            };

            // Mobile Tab Logic
            const renderContent = () => {
                if (loading) return <div className="p-10 text-center"><i className="fas fa-spinner fa-spin text-2xl"></i><p>è¼‰å…¥è¡Œç¨‹ä¸­...</p></div>;
                if (error) return (
                    <div className="p-8 text-center text-red-500">
                        <i className="fas fa-exclamation-triangle text-3xl mb-2"></i>
                        <p className="font-bold">è³‡æ–™è®€å–å¤±æ•—</p>
                        <p className="text-sm mt-2">{error}</p>
                        <div className="mt-4 bg-gray-100 p-4 rounded text-xs text-left text-gray-600">
                            <strong>Troubleshooting:</strong><br/>
                            1. ç¢ºä¿ `itinerary.json` èˆ‡ html åœ¨åŒä¸€ç›®éŒ„ã€‚<br/>
                            2. è‹¥ä½¿ç”¨ Chrome ç›´æ¥é–‹å•Ÿ htmlï¼Œå¯èƒ½æœƒå›  CORS è¢«æ“‹ã€‚è«‹å˜—è©¦å°‡æª”æ¡ˆæ¨é€åˆ° GitHub Pagesï¼Œæˆ–ä½¿ç”¨ VS Code Live Server åŸ·è¡Œã€‚
                        </div>
                    </div>
                );

                if (activeTab === 'search') return <div className="p-5 text-gray-500 text-center mt-10">ğŸ” æœå°‹åŠŸèƒ½ (é–‹ç™¼ä¸­)</div>;
                if (activeTab === 'guide') return (
                    <div className="p-5 overflow-y-auto">
                        <h2 className="text-xl font-bold mb-4">â˜ƒï¸ å†¬å­£ç”Ÿå­˜æŒ‡å—</h2>
                        <ul className="list-disc pl-5 space-y-2 text-sm text-gray-700">
                            <li><strong>æ´‹è”¥å¼ç©¿æ­ï¼š</strong>å®¤å…§æš–æ°£æ¥µå¼·ï¼Œå‹™å¿…ç©¿è‘—å¥½ç©¿è„«çš„è¡£ç‰©ã€‚</li>
                            <li><strong>é‹å­é˜²æ»‘ï¼š</strong>ä¸­æ­çŸ³æ¿è·¯çµå†°éå¸¸æ»‘ï¼Œå»ºè­°ç©¿è‘—å…·æœ‰æ·±é½’ç—•çš„é˜²æ°´é´ã€‚</li>
                            <li><strong>ä¿æ¿•ï¼š</strong>ç©ºæ°£æ¥µåº¦ä¹¾ç‡¥ï¼Œè­·å”‡è†èˆ‡èº«é«”ä¹³æ¶²æ˜¯å¿…éœ€å“ã€‚</li>
                            <li><strong>æ—¥ç…§æ™‚é–“ï¼š</strong>ä¸‹åˆ4é»å·¦å³å¤©é»‘ï¼Œå»ºè­°è¡Œç¨‹æ—©å‡ºæ—©æ­¸ã€‚</li>
                            <li><strong>ç¾é‡‘ï¼š</strong>å¾·åœ‹èˆ‡å¥§åœ°åˆ©éƒ¨åˆ†å°åº—ä»åªæ”¶ç¾é‡‘ï¼Œéš¨èº«æº–å‚™å°‘é‡æ­å…ƒã€‚</li>
                        </ul>
                    </div>
                );

                // Itinerary List
                return (
                    <div className="pb-24 md:pb-0">
                        {data.map((dayData) => (
                            <div key={dayData.day} className="border-b border-gray-200">
                                {/* Day Header */}
                                <div 
                                    className={`sticky top-0 z-10 flex justify-between items-center p-4 cursor-pointer bg-white hover:bg-gray-50 transition-colors shadow-sm
                                        ${activeDay === dayData.day ? 'border-l-4 border-blue-500' : ''}`}
                                    onClick={() => toggleDay(dayData.day)}
                                >
                                    <div>
                                        <div className="text-xs font-bold text-gray-400 uppercase tracking-wide">{dayData.day}</div>
                                        <div className="font-bold text-lg text-gray-800">{dayData.city}</div>
                                    </div>
                                    <i className={`fas fa-chevron-down transition-transform ${activeDay === dayData.day ? 'rotate-180' : ''} text-gray-400`}></i>
                                </div>

                                {/* Spots List (Accordion Body) */}
                                {activeDay === dayData.day && (
                                    <div className="bg-gray-50 animate-fade-in">
                                        {dayData.spots.map((spot, idx) => {
                                            const uniqueId = `${dayData.day}-${idx}`;
                                            const isSelected = activeSpotId === uniqueId;
                                            
                                            return (
                                                <div 
                                                    key={idx} 
                                                    className={`relative pl-8 pr-4 py-3 border-l-2 ml-4 my-2 cursor-pointer transition-all duration-300
                                                        ${isSelected ? 'border-blue-500 bg-white shadow-md rounded-r-lg scale-[1.02]' : 'border-gray-300 hover:bg-gray-100'}`}
                                                    onClick={() => handleSpotClick(dayData.day, idx, spot)}
                                                >
                                                    {/* Timeline Node */}
                                                    <div className={`absolute -left-[9px] top-5 w-4 h-4 rounded-full border-2 border-white 
                                                        ${isSelected ? 'bg-blue-500 scale-125' : 'bg-gray-300'}`}>
                                                        <span className="flex items-center justify-center text-[8px] text-white h-full w-full">{idx+1}</span>    
                                                    </div>

                                                    <div className="flex justify-between items-start">
                                                        <div className="flex-1">
                                                            <div className="flex items-center gap-2 mb-1">
                                                                <TypeBadge type={spot.type} />
                                                                <span className="text-xs text-gray-500"><i className="far fa-clock mr-1"></i>{spot.time}</span>
                                                            </div>
                                                            <h3 className={`font-bold ${isSelected ? 'text-blue-700' : 'text-gray-800'}`}>{spot.name}</h3>
                                                            {spot.trans && (
                                                                <div className="text-xs text-gray-500 mt-1 flex items-center">
                                                                    <i className="fas fa-route mr-1"></i> {spot.trans}
                                                                </div>
                                                            )}
                                                        </div>
                                                        <button 
                                                            className="ml-2 w-8 h-8 flex items-center justify-center rounded-full bg-red-50 text-red-500 hover:bg-red-500 hover:text-white transition-colors"
                                                            onClick={(e) => openGoogleMaps(e, spot.name, dayData.city)}
                                                            title="åœ¨ Google Maps æœå°‹"
                                                        >
                                                            <i className="fas fa-map-marker-alt"></i>
                                                        </button>
                                                    </div>

                                                    {/* Expandable Details */}
                                                    <div className={`details-grid ${isSelected ? 'open' : ''}`}>
                                                        <div className="overflow-hidden">
                                                            <div className="mt-3 pt-3 border-t border-dashed border-gray-200 text-sm text-gray-600 space-y-1">
                                                                {spot.details.open && <div><span className="font-semibold w-16 inline-block">ç‡Ÿæ¥­:</span> {spot.details.open}</div>}
                                                                {spot.details.price && <div><span className="font-semibold w-16 inline-block">æ¶ˆè²»:</span> {spot.details.price}</div>}
                                                                {(!spot.details.open && !spot.details.price) && <div className="italic text-gray-400">å°šç„¡è©³ç´°è³‡è¨Š</div>}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                );
            };

            return (
                <div className="flex flex-col md:flex-row h-full">
                    {/* Sidebar / Mobile List */}
                    <div className={`
                        flex flex-col w-full md:w-1/3 h-full bg-white shadow-xl z-20 transition-transform duration-300 absolute md:relative
                        ${isMobileListOpen ? 'translate-y-0' : 'translate-y-[calc(100%-60px)] md:translate-y-0'}
                    `}>
                        {/* Header */}
                        <header className="bg-gradient-to-r from-blue-900 to-blue-700 text-white p-4 shadow-lg flex-shrink-0 flex justify-between items-center">
                            <div>
                                <h1 className="text-xl font-bold"><i className="fas fa-snowflake mr-2"></i>24å¤©ä¸­æ­å†¬ä¹‹æ—…</h1>
                                <p className="text-xs text-blue-200 mt-1">Winter Europe Trip 2025</p>
                            </div>
                            {/* Mobile Toggle Button */}
                            <button className="md:hidden text-white p-2" onClick={() => setIsMobileListOpen(!isMobileListOpen)}>
                                <i className={`fas ${isMobileListOpen ? 'fa-map' : 'fa-list'} text-xl`}></i>
                            </button>
                        </header>

                        {/* Content Area */}
                        <div className="flex-1 overflow-y-auto relative bg-white">
                            {renderContent()}
                        </div>

                        {/* Bottom Tabs */}
                        <div className="flex-shrink-0 bg-white border-t border-gray-200 flex justify-around p-2 pb-safe">
                            <button 
                                className={`flex flex-col items-center p-2 text-xs ${activeTab === 'itinerary' ? 'text-blue-600' : 'text-gray-400'}`}
                                onClick={() => { setActiveTab('itinerary'); setIsMobileListOpen(true); }}
                            >
                                <i className="fas fa-list-ul text-lg mb-1"></i>
                                æ¯æ—¥è¡Œç¨‹
                            </button>
                            <button 
                                className={`flex flex-col items-center p-2 text-xs ${activeTab === 'search' ? 'text-blue-600' : 'text-gray-400'}`}
                                onClick={() => setActiveTab('search')}
                            >
                                <i className="fas fa-search text-lg mb-1"></i>
                                æ™¯é»æœå°‹
                            </button>
                            <button 
                                className={`flex flex-col items-center p-2 text-xs ${activeTab === 'guide' ? 'text-blue-600' : 'text-gray-400'}`}
                                onClick={() => { setActiveTab('guide'); setIsMobileListOpen(true); }}
                            >
                                <i className="fas fa-book-open text-lg mb-1"></i>
                                ç”Ÿå­˜æŒ‡å—
                            </button>
                        </div>
                    </div>

                    {/* Right Map */}
                    <div className="flex-1 h-full w-full relative">
                         <div id="map"></div>
                         {/* Mobile Map Toggle Hint when list is up */}
                         {isMobileListOpen && (
                            <div className="md:hidden absolute bottom-24 right-4 z-[400]">
                                <button 
                                    className="bg-blue-600 text-white p-3 rounded-full shadow-lg animate-bounce"
                                    onClick={() => setIsMobileListOpen(false)}
                                >
                                    <i className="fas fa-map-marked-alt"></i>
                                </button>
                            </div>
                         )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>